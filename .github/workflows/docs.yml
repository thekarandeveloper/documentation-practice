name: Build & Publish DocC (ALTERNATIVE)
on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  docs:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode.app
          xcodebuild -version
          echo "docc version:"
          xcrun docc --version || echo "docc not found in PATH"
      
      - name: Build DocC archive
        run: |
          xcodebuild docbuild \
            -scheme documentation-practice \
            -destination 'generic/platform=iOS Simulator' \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER=""
      
      - name: Locate DocC archive
        run: |
          DOCC_ARCHIVE=$(find build -name "*.doccarchive" -type d | head -1)
          echo "DOCC_ARCHIVE=$DOCC_ARCHIVE" >> $GITHUB_ENV
          echo "Found archive at: $DOCC_ARCHIVE"
          
          # Verify it has data
          if [ -d "$DOCC_ARCHIVE/data" ]; then
            echo "‚úÖ Archive has $(find "$DOCC_ARCHIVE/data" -name "*.json" | wc -l) JSON files"
          fi
      
      # METHOD 1: Try process-archive (older command)
      - name: Try process-archive transform
        continue-on-error: true
        id: process_archive
        run: |
          xcrun docc process-archive transform-for-static-hosting \
            "$DOCC_ARCHIVE" \
            --hosting-base-path documentation-practice \
            --output-path docs-site-method1
      
      # METHOD 2: Try convert with different flags
      - name: Try convert with additional flags
        continue-on-error: true
        id: convert_flags
        run: |
          xcrun docc convert "$DOCC_ARCHIVE" \
            --transform-for-static-hosting \
            --hosting-base-path documentation-practice \
            --output-path docs-site-method2 \
            --emit-digest \
            --index-paths "$DOCC_ARCHIVE/index"
      
      # METHOD 3: Try without --allow-arbitrary-catalog-directories
      - name: Try convert without arbitrary catalogs flag
        continue-on-error: true
        id: convert_simple
        run: |
          xcrun docc convert "$DOCC_ARCHIVE" \
            --transform-for-static-hosting \
            --hosting-base-path documentation-practice \
            --output-path docs-site-method3
      
      # METHOD 4: Manual extraction (guaranteed to work)
      - name: Manual extraction method
        run: |
          echo "=== Extracting archive manually ==="
          
          # Create output directory
          mkdir -p docs-site
          
          # Copy the entire archive structure
          cp -R "$DOCC_ARCHIVE"/* docs-site/
          
          echo "‚úÖ Manual extraction complete"
          ls -la docs-site/
      
      - name: Check which method worked
        run: |
          echo "=== Checking results ==="
          
          for method in method1 method2 method3 ""; do
            if [ -z "$method" ]; then
              dir="docs-site"
              name="Manual"
            else
              dir="docs-site-$method"
              name="Method $(echo $method | sed 's/method//')"
            fi
            
            if [ -d "$dir" ]; then
              echo ""
              echo "[$name]"
              if [ -d "$dir/data" ]; then
                echo "  ‚úÖ Has data folder"
                echo "  üìä JSON files: $(find "$dir/data" -name "*.json" 2>/dev/null | wc -l)"
                echo "  üìÅ Size: $(du -sh "$dir" 2>/dev/null | cut -f1)"
              else
                echo "  ‚ùå No data folder"
              fi
            fi
          done
          
          # Use the method that worked
          if [ -d "docs-site-method1/data" ]; then
            echo "Using method1 (process-archive)"
            rm -rf docs-site
            mv docs-site-method1 docs-site
          elif [ -d "docs-site-method2/data" ]; then
            echo "Using method2 (convert with flags)"
            rm -rf docs-site
            mv docs-site-method2 docs-site
          elif [ -d "docs-site-method3/data" ]; then
            echo "Using method3 (simple convert)"
            rm -rf docs-site
            mv docs-site-method3 docs-site
          else
            echo "Using manual extraction"
            # docs-site already has the manual extraction
          fi
      
      - name: Verify final output
        run: |
          if [ -d "docs-site/data" ]; then
            echo "‚úÖ Final docs-site has data folder"
            echo "JSON files: $(find docs-site/data -name "*.json" | wc -l)"
          else
            echo "‚ùå No data folder in final output"
            exit 1
          fi
      
      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs-site
          force_orphan: true
